<?php 

define("_DIRECT_ACCESS_", "false");
//include("config.php");
include('config.php');
needNotLogin();

$sign = false;
$rand[1] = rand(1,9);
$rand[2] = rand(1,9);
$rand[3] = $rand[1]+$rand[2];

if(isset($_POST['signup'])) {
				
	if(noFieldEmpty($_POST)) {
		extract($_POST);
		$userlog = mysql_real_escape_string($userlog);
		$mail = mysql_real_escape_string($mail);
		if($pwd!=$cpwd)
			$alert_page = '<div class="error msg">Les deux mots de passe ne correspondent pas.</div>';
		elseif($mail!=$cmail)
			$alert_page = '<div class="error msg">Les deux email ne correspondent pas.</div>';
		elseif(alreadyExists('utilisateurs', array('email'), $mail))
			$alert_page = '<div class="error msg">Cette adresse email est dejà prise.</div>';
		elseif(alreadyExists('utilisateurs', array('login'), $userlog))
			$alert_page = '<div class="error msg">Ce nom d\'utilisateur est dejà pris.</div>';
		elseif(strlen($userlog)<5)
			$alert_page = '<div class="error msg">Nom d\'utilisateur trop court (5 carac. minimum).</div>';
		elseif(strlen($pwd)<5)
			$alert_page = '<div class="error msg">Mot de passe trop court (5 carac. minimum).</div>';
		elseif($captcha!=$reponse)
			$alert_page = '<div class="error msg">Réponse à la question incorrecte.</div>';
		else {
			if(Auth::trySignup($_POST)) {
				$alert_page = '<div class="success msg">Inscription terminée, vous devez à présent attendre qu\'un administrateur valide votre compte.</div>';
				$sign=true;
			} else { 
				$alert_page = '<div class="error msg">Erreur lors du processus d\'inscription.</div>';
			}
		}
	} else {
		$alert_page = '<div class="error msg">Des champs sont restés vides.</div>';
	}
}

?>
<!DOCTYPE HTML>
<html lang="fr">
<head>
	<title>P.T.I.B. | Connexion</title>
	<meta charset="iso-8859-1">
	<link rel="stylesheet" type="text/css" href="theme/css/style.css">
	<link rel="stylesheet" type="text/css" href="theme/css/skins/blue.css" title="blue">
	<link rel="stylesheet" type="text/css" href="theme/css/superfish.css">
	<link rel="stylesheet" type="text/css" href="theme/css/uniform.default.css">
	<link rel="stylesheet" type="text/css" href="theme/css/jquery.wysiwyg.css">
	<link rel="stylesheet" type="text/css" href="theme/css/facebox.css">
	<link rel="stylesheet" type="text/css" href="theme/css/smoothness/jquery-ui-1.8.8.custom.css">
	<link rel='stylesheet' type="text/css" href="theme/css/jqueryFileTree.css" />
	<!--[if lte IE 8]>
	<script type="text/javascript" src="js/html5.js"></script>
	<![endif]-->
	<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.8.custom.min.js"></script>
	<script type="text/javascript" src="js/jquery.validate.min.js"></script>
	<script type="text/javascript" src="js/jquery.uniform.min.js"></script>
	<script type="text/javascript" src="js/jquery.wysiwyg.js"></script>
	<script type="text/javascript" src="js/superfish.js"></script>
	<script type="text/javascript" src="js/cufon-yui.js"></script>
	<script type="text/javascript" src="js/Delicious_500.font.js"></script>
	<script type="text/javascript" src="js/jquery.flot.min.js"></script>
	<script type="text/javascript" src="js/custom.js"></script>
	<script type="text/javascript" src="js/facebox.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.easing.1.3"></script>
	<script type="text/javascript" src="http://code.jquery.com/jquery-git.js"></script>
</head>
<body>

<header id="top">
	<div class="container_12 clearfix">
		<div id="logo" class="grid_5">
			<a id="site-title" href="index.php"><span>P</span>ortail <span>P</span>.<span>T</span>.<span>I</span>.<span>B</span>.</a>
		</div>
		<div class="grid_4" id="colorstyle"></div>
		<div id="userinfo" class="grid_3">
			<a href="../">Retour au site</a>
		</div>
	</div>
</header>

<div id="login" class="box">
	<h2>Espace réservé</h2>
	<section>
			
		<?php if(isset($alert_page)) { echo $alert_page; } ?>
		<?php if(isset($_GET['action']) && $_GET['action']=='signup') 
		
		{
				if(!$sign) { ?>
		<form action="login.php?action=signup" method="post">
			<div class="information msg">Tous les champs sont obligatoires</div>
			<dl>
				<dt><label for="userlog">Nom d'utilisateur</label></dt>
				<dd><input name="userlog" id="userlog" type="text" />
					<small>5 caractères minimum</small></dd>
				<dt><label for="pwd">Mot de passe</label></dt>
				<dd><input name="pwd" id="pwd" type="password" />
					<small>5 caractères minimum</small></dd>
				<dt><label for="cpwd">Confirmez le mot de passe</label></dt>
				<dd><input name="cpwd" id="cpwd" type="password" /></dd>
				<dt><label for="mail">Adresse email</label></dt>
				<dd><input name="mail" id="mail" type="text" /></dd>
				<dt><label for="cmail">Confirmez l'adresse email</label></dt>
				<dd><input name="cmail" id="cmail" type="text" /></dd>
				<dt><label for="firm">Société</label></dt>
				<dd><input name="firm" id="firm" type="text" /></dd>
				<dt><label for="captcha">Question : <?php echo $rand[1]." + ".$rand[2]; ?> = ?</label></dt>
				<dd><input name="captcha" id="captcha" type="text" /></dd>
				<input name="reponse" type="hidden" value="<?php echo $rand[3]; ?>" />
			</dl>
			<p>
				<input type="hidden" name="signup" value="true" />
				<button type="submit" class="button gray" id="loginbtn">Inscription</button>
				<span id="forgot"><a href="login.php">Retour</a><br /></span>
			</p>
		</form>
		<?php 	} else { ?> 
			<p class="aligncenter"><a href="login.php">Retour</a></p>
		<?php 	}
			}  else {
			  	if(isset($_POST['send']) && !Auth::tryLogin($_POST)) { ?>
		<div class="error msg">Les identifiants semblent incorrects</div>
		<?php 	}
				if((isset($_POST['send']) && !Auth::tryLogin($_POST)) or !isset($_POST['send'])) { ?>
		<form action="login.php" method="post">
			<dl>
				<dt><label for="user">Nom d'utilisateur</label></dt>
				<dd><input name="user" id="user" type="text" /></dd>
				<dt><label for="pwd">Mot de passe</label></dt>
				<dd><input name="pwd" id="pwd" type="password" /></dd>
			</dl>
			<p>
				<input type="hidden" name="send" value="true" />
				<button type="submit" class="button gray" id="loginbtn">Se connecter</button>
				<span id="forgot"><a href="login.php?action=signup">Inscription</a><br /></span>
			</p>
		</form><br />
		<p class="aligncenter"><a href="pages/navigateurs.php" rel="facebox"><img src="images/compa_nav.png" alt="" /><br />Liste des navigateurs compatibles</a></p>
		<?php 	} else { ?>
		<p align="center"><img src="theme/images/loading.gif" alt="" /><p>
		<div class="success msg">

			Vous êtes à présent connecté. Vous allez être redirigé dans 3 secondes...
			
		</div>
		<?php 	//redirect("index.php"); }} 
		
		redirect('index.php'); }} 
		?>
		<?php 
			?>
	</section>
</div>
</body>
</html>
